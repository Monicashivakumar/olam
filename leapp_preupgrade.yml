---
- name: Leapp Preupgrade stage
  hosts: all
  become: yes
  vars_files:
    - vars/defaults.yml
    - vars/vars.yml
  vars:    
     leapp_switch: "{{ leapp_switch | default('--oraclelinux') }}"

  tasks:
     - name: Run leapp pre upgrade
       ansible.builtin.shell: >
          set -o pipefail && leapp preupgrade --oraclelinux >/dev/null 2>&1; exit $?
       register: leapp_result
       failed_when: leapp_result.rc != 0
       changed_when: false
       ignore_errors: yes
       
     - name: Print lines 
       ansible.builtin.shell: grep -i -A5 "Risk Factor" /var/log/leapp/leapp-report.txt
       register: risk_factor_lines

     - name: Display lines 
       ansible.builtin.debug:
          var: risk_factor_lines.stdout_lines

     - name: Fetch files from remote host using fetch
       ansible.builtin.fetch:
         src: "/var/log/leapp/leapp-report.txt"
         dest: "/tmp/"
         flat: yes

     - name: Display contents of answerfile
       ansible.builtin.shell: cat /var/log/leapp/answerfile
       register: answerfile_content

     - name: Print answerfile content
       ansible.builtin.debug:
         var: answerfile_content.stdout_lines

     - name: Remove_pam_pkcs11_module_check
       ansible.builtin.command: sudo leapp answer --section remove_pam_pkcs11_module_check.confirm=True

    
       

       
      
